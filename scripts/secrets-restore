#!/bin/bash
# =============================================================================
# secrets-restore - Restore/symlink secrets to project directories
# =============================================================================
# Run this after cloning dotfiles to set up secrets in your projects
#
# Usage: secrets-restore
# =============================================================================

set -e

DOTFILES_DIR="$HOME/dotfiles"
SECRETS_DIR="$DOTFILES_DIR/secrets"

echo "=================================================="
echo "  Secrets Restore"
echo "=================================================="
echo ""

# Check if secrets are encrypted
check_encrypted() {
    local file="$1"
    if head -1 "$file" 2>/dev/null | grep -q "^VAULT_ENCRYPTED"; then
        return 0
    fi
    return 1
}

# Decrypt if needed
ensure_decrypted() {
    local file="$1"
    if check_encrypted "$file"; then
        echo "  Decrypting $(basename "$file")..."
        "$DOTFILES_DIR/scripts/vault" decrypt "$file"
    fi
}

# Create symlink
create_link() {
    local source="$1"
    local target="$2"

    if [[ -L "$target" ]]; then
        echo "  ✓ Already linked: $target"
    elif [[ -f "$target" ]]; then
        echo "  ⚠ File exists (backing up): $target"
        mv "$target" "$target.backup"
        ln -sf "$source" "$target"
        echo "  ✓ Linked: $target"
    else
        ln -sf "$source" "$target"
        echo "  ✓ Linked: $target"
    fi
}

# -----------------------------------------------------------------------------
# pie-go
# -----------------------------------------------------------------------------
if [[ -d "$HOME/projects/pie-go" ]]; then
    echo "[pie-go]"
    if [[ -f "$SECRETS_DIR/pie-go/service-account.json" ]]; then
        ensure_decrypted "$SECRETS_DIR/pie-go/service-account.json"
        create_link "$SECRETS_DIR/pie-go/service-account.json" "$HOME/projects/pie-go/service-account.json"
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# pie-frontend
# -----------------------------------------------------------------------------
if [[ -d "$HOME/projects/pie-frontend" ]]; then
    echo "[pie-frontend]"
    if [[ -f "$SECRETS_DIR/pie-frontend/.env" ]]; then
        ensure_decrypted "$SECRETS_DIR/pie-frontend/.env"
        create_link "$SECRETS_DIR/pie-frontend/.env" "$HOME/projects/pie-frontend/.env"
    fi
    echo ""
fi

# -----------------------------------------------------------------------------
# Add more projects here as needed
# -----------------------------------------------------------------------------
# if [[ -d "$HOME/projects/your-project" ]]; then
#     echo "[your-project]"
#     if [[ -f "$SECRETS_DIR/your-project/.env" ]]; then
#         ensure_decrypted "$SECRETS_DIR/your-project/.env"
#         create_link "$SECRETS_DIR/your-project/.env" "$HOME/projects/your-project/.env"
#     fi
#     echo ""
# fi

echo "=================================================="
echo "  Done!"
echo "=================================================="
echo ""
echo "To encrypt secrets before committing:"
echo "  vault encrypt ~/dotfiles/secrets/pie-go/service-account.json"
echo "  vault encrypt ~/dotfiles/secrets/pie-frontend/.env"
